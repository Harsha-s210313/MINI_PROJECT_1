<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Street Light Accident Alert System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        /* --- ORIGINAL CSS PRESERVED --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .header h1 { color: #333; font-size: 28px; display: flex; align-items: center; gap: 12px; }
        .status-indicator { display: flex; align-items: center; gap: 10px; padding: 10px 20px; background: #f0f0f0; border-radius: 8px; font-weight: 600; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; background: #4CAF50; animation: pulse 2s infinite; }
        .status-dot.alert { background: #FF5252; animation: blink 0.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
        .content { display: grid; grid-template-columns: 1fr 350px; gap: 25px; margin-bottom: 25px; }
        #map { height: 600px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .card h3 { color: #333; margin-bottom: 15px; font-size: 16px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .alert-item { padding: 15px; margin-bottom: 12px; background: #fff3cd; border-left: 4px solid #ff9800; border-radius: 6px; font-size: 13px; color: #333; }
        .alert-item.critical { background: #ffebee; border-left-color: #FF5252; }
        .alert-item.resolved { background: #e8f5e9; border-left-color: #4CAF50; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 13px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .info-row:last-child { border-bottom: none; }
        .label { color: #666; font-weight: 600; }
        .value { color: #333; font-weight: 500; }
        .button-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 10px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 12px; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn-secondary:hover { background: #e0e0e0; }
        .alert-list { max-height: 300px; overflow-y: auto; }
        .empty-state { text-align: center; padding: 30px 20px; color: #999; }
        
        /* --- NEW CSS FOR SENSOR DATA --- */
        .sensor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .sensor-box { background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center; }
        .sensor-label { font-size: 11px; color: #666; display: block; margin-bottom: 4px; }
        .sensor-val { font-size: 14px; font-weight: bold; color: #333; }
        .node-status-active { color: #4CAF50; font-weight: bold; }
        .node-status-offline { color: #FF5252; font-weight: bold; }

        @media (max-width: 768px) {
            .content { grid-template-columns: 1fr; }
            .header { flex-direction: column; text-align: center; }
            #map { height: 400px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® Street Light Accident Alert System</h1>
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">System Offline</span>
            </div>
        </div>

        <div class="content">
            <div id="map"></div>
            
            <div class="sidebar">
                <div class="card">
                    <h3>üì° Live Node Telemetry</h3>
                    <div id="liveNodeContainer">
                        <div class="empty-state">Waiting for data...</div>
                    </div>
                </div>

                <div class="card">
                    <h3>üìç Latest Incident</h3>
                    <div id="latestIncident" class="empty-state">
                        <p>No incidents detected</p>
                    </div>
                </div>

                <div class="card">
                    <h3>üìã Alert History</h3>
                    <div class="alert-list" id="alertHistory">
                        <div class="empty-state">
                            <p>No alerts yet</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>‚öôÔ∏è System Controls</h3>
                    <div class="button-group">
                        <button class="btn-primary" onclick="startSimulation()">Test Simulation</button>
                        <button class="btn-secondary" onclick="clearAlerts()">Clear All</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let accidentMarkers = [];
        let accidents = [];
        let activeAccidentIds = new Set(); // To prevent spamming alerts for same accident

        // Initialize the map
        function initMap() {
            map = L.map('map').setView([18.28952, 83.82556], 15); // Default Srikakulam

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        }

        // --- FETCH DATA FROM NODE.JS SERVER ---
        function startLiveUpdate() {
            // Poll the server every 2 seconds
            setInterval(fetchSensorData, 2000);
        }

        function fetchSensorData() {
            fetch('/api/sensor-data')
                .then(response => response.json())
                .then(data => {
                    updateSystemStatus(true);
                    renderNodeData(data.nodes);
                    checkAutoAlerts(data.nodes);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    updateSystemStatus(false);
                });
        }

        function updateSystemStatus(isOnline) {
            const statusText = document.getElementById('statusText');
            const statusDot = document.getElementById('statusDot');
            
            if (isOnline) {
                if (!statusText.textContent.includes("Alert")) {
                    statusText.textContent = "System Online";
                    statusDot.style.background = "#4CAF50";
                }
            } else {
                statusText.textContent = "Server Offline";
                statusDot.style.background = "#999";
            }
        }

        function renderNodeData(nodes) {
            const container = document.getElementById('liveNodeContainer');
            
            if (!nodes || nodes.length === 0) {
                container.innerHTML = '<div class="empty-state">No active nodes connected</div>';
                return;
            }

            let html = '';
            nodes.forEach(node => {
                html += `
                <div style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px;">
                    <div class="info-row">
                        <span class="value">Node ${node.nodeId}</span>
                        <span class="${node.connectionStatus === 'Active' ? 'node-status-active' : 'node-status-offline'}">
                            ${node.connectionStatus}
                        </span>
                    </div>
                    
                    <div class="sensor-grid">
                        <div class="sensor-box">
                            <span class="sensor-label">Distance</span>
                            <span class="sensor-val">${node.sensors.ultrasonic.distance} cm</span>
                        </div>
                        <div class="sensor-box">
                            <span class="sensor-label">Vibration</span>
                            <span class="sensor-val" style="color:${node.sensors.vibration.count > 0 ? 'red' : '#333'}">
                                ${node.sensors.vibration.count}
                            </span>
                        </div>
                        <div class="sensor-box">
                            <span class="sensor-label">Light</span>
                            <span class="sensor-val">${node.sensors.ldr.lightLevel}</span>
                        </div>
                        <div class="sensor-box">
                            <span class="sensor-label">LED</span>
                            <span class="sensor-val">${node.ledState ? 'ON' : 'OFF'}</span>
                        </div>
                    </div>
                    <div style="font-size:11px; color:#666; text-align:right;">
                        Lat: ${node.gps.latitude.toFixed(5)}, Lng: ${node.gps.longitude.toFixed(5)}
                    </div>
                </div>
                `;
            });
            container.innerHTML = html;
        }

        function checkAutoAlerts(nodes) {
            if (!nodes) return;

            nodes.forEach(node => {
                // LOGIC: Trigger alert if Vibration count is high OR eventType says "Accident"
                // Also ensures we have valid GPS (not 0,0)
                if ((node.sensors.vibration.count > 200 || node.eventType.includes("Accident")) && node.gps.latitude != 0) {
                    
                    // Simple debounce: Don't re-trigger if we just did for this node recently
                    // In a real app, you might match IDs from the backend
                    if (!activeAccidentIds.has(node.nodeId)) {
                        activeAccidentIds.add(node.nodeId);
                        recordAccident(node.gps.latitude, node.gps.longitude, node.nodeId);
                        
                        // Auto-reset debounce after 30 seconds
                        setTimeout(() => activeAccidentIds.delete(node.nodeId), 30000);
                    }
                }
            });
        }

        // --- ORIGINAL MAP & ALERT FUNCTIONS ---

        function addAccidentMarker(lat, lng, timestamp, id) {
            const marker = L.marker([lat, lng], {
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDMyIDMyIj48Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSIxNSIgZmlsbD0iI0ZGNTI1MiIvPjxjaXJjbGUgY3g9IjE2IiBjeT0iMTYiIHI9IjEwIiBmaWxsPSIjRkZGIi8+PC9zdmc+',
                    iconSize: [32, 32],
                    popupAnchor: [0, -16]
                })
            }).addTo(map);

            marker.bindPopup(`
                <div style="font-weight: 600; margin-bottom: 8px;">üö® Accident Detected</div>
                <div>Lat: ${lat.toFixed(6)}</div>
                <div>Lng: ${lng.toFixed(6)}</div>
                <div style="font-size: 12px; color: #666; margin-top: 8px;">${new Date(timestamp).toLocaleTimeString()}</div>
            `);

            accidentMarkers.push({ id, marker });
            map.setView([lat, lng], 16);
        }

        function recordAccident(lat, lng, nodeId = 'Unknown') {
            if (lat === 0 && lng === 0) return;

            const id = Date.now();
            const accident = {
                id,
                nodeId,
                latitude: lat,
                longitude: lng,
                timestamp: new Date(),
                status: 'active'
            };

            accidents.unshift(accident);
            addAccidentMarker(lat, lng, accident.timestamp, id);
            updateLatestIncident(accident);
            updateAlertHistory();
            activateAlert();
        }

        function resolveAccident(id) {
            const accident = accidents.find(a => a.id === id);
            if (accident) {
                accident.status = 'resolved';
                updateAlertHistory();
                deactivateAlert();
            }
        }

        function updateLatestIncident(accident) {
            const latestDiv = document.getElementById('latestIncident');
            latestDiv.innerHTML = `
                <div class="info-row">
                    <span class="label">Status:</span>
                    <span class="value" style="color: ${accident.status === 'active' ? '#FF5252' : '#4CAF50'}; font-weight: 700;">
                        ${accident.status.toUpperCase()}
                    </span>
                </div>
                 <div class="info-row">
                    <span class="label">Source:</span>
                    <span class="value">Node ${accident.nodeId}</span>
                </div>
                <div class="info-row">
                    <span class="label">Location:</span>
                    <span class="value">${accident.latitude.toFixed(5)}, ${accident.longitude.toFixed(5)}</span>
                </div>
                <div class="info-row">
                    <span class="label">Time:</span>
                    <span class="value">${accident.timestamp.toLocaleTimeString()}</span>
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="resolveAccident(${accident.id})">Resolve</button>
                </div>
            `;
        }

        function updateAlertHistory() {
            const historyDiv = document.getElementById('alertHistory');
            
            if (accidents.length === 0) {
                historyDiv.innerHTML = '<div class="empty-state"><p>No alerts yet</p></div>';
                return;
            }

            historyDiv.innerHTML = accidents.map(a => `
                <div class="alert-item ${a.status === 'active' ? 'critical' : 'resolved'}">
                    <div style="font-weight: 600; margin-bottom: 5px;">
                        ${a.status === 'active' ? 'üö® Active' : '‚úì Resolved'} (Node ${a.nodeId})
                    </div>
                    <div>üìç ${a.latitude.toFixed(4)}, ${a.longitude.toFixed(4)}</div>
                    <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">
                        ${a.timestamp.toLocaleTimeString()}
                    </div>
                </div>
            `).join('');
        }

        function activateAlert() {
            document.getElementById('statusDot').className = 'status-dot alert';
            document.getElementById('statusText').textContent = '‚ö†Ô∏è Accident Alert!';
        }

        function deactivateAlert() {
            if (accidents.some(a => a.status === 'active')) return;
            document.getElementById('statusDot').className = 'status-dot';
            document.getElementById('statusText').textContent = 'System Online';
        }

        function startSimulation() {
            const lat = 18.28952 + (Math.random() - 0.5) * 0.01;
            const lng = 83.82556 + (Math.random() - 0.5) * 0.01;
            recordAccident(lat, lng, 'Sim-1');
        }

        function clearAlerts() {
            accidents = [];
            activeAccidentIds.clear();
            accidentMarkers.forEach(m => map.removeLayer(m.marker));
            accidentMarkers = [];
            document.getElementById('latestIncident').innerHTML = '<div class="empty-state"><p>No incidents detected</p></div>';
            updateAlertHistory();
            deactivateAlert();
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            initMap();
            startLiveUpdate(); // Start pulling data from Node.js
        });
    </script>
</body>
</html>
